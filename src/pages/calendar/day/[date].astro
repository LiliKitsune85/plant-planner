---
import AppShell from "@/layouts/AppShell.astro";
import { CalendarDayView } from "@/components/calendar/day/CalendarDayView";
import {
  isValidCalendarDate,
  normalizeCalendarDayOrder,
  normalizeCalendarDaySort,
  normalizeCalendarDayStatus,
} from "@/lib/services/calendar/day-view-model";
import type {
  CalendarTaskSortField,
  CalendarTaskStatusFilter,
  SortOrder,
} from "@/lib/services/calendar/types";

export const prerender = false;

const dateParam = Astro.params.date ?? "";
const statusParam = Astro.url.searchParams.get("status") ?? undefined;
const sortParam = Astro.url.searchParams.get("sort") ?? undefined;
const orderParam = Astro.url.searchParams.get("order") ?? undefined;

const status = normalizeCalendarDayStatus(statusParam as CalendarTaskStatusFilter | undefined);
const sort = normalizeCalendarDaySort(sortParam as CalendarTaskSortField | undefined);
const order = normalizeCalendarDayOrder(orderParam as SortOrder | undefined);

const isValidDate = isValidCalendarDate(dateParam);
const safeDate = dateParam ?? "";
const pageTitle = isValidDate ? `Kalendarz — ${safeDate}` : "Kalendarz — niepoprawna data";
---

<AppShell title={pageTitle} section="calendar">
  <CalendarDayView
    date={safeDate}
    status={status}
    sort={sort}
    order={order}
    client:load
  />
</AppShell>
