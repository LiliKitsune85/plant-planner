---
import Layout from './Layout.astro'

type NavSection = 'calendar' | 'plants' | 'settings'

interface Props {
  title?: string
  section?: NavSection
}

const { title = 'Plant Planner', section } = Astro.props as Props

const navItems: Array<{ key: NavSection; label: string; href: string; description: string }> = [
  { key: 'calendar', label: 'Kalendarz', href: '/calendar', description: 'Przegląd i zadania' },
  { key: 'plants', label: 'Rośliny', href: '/plants', description: 'Twoja kolekcja' },
  { key: 'settings', label: 'Ustawienia', href: '/settings', description: 'Profil i preferencje' },
]

const pathname = Astro.url.pathname

const autoSection =
  navItems.find((item) => pathname === item.href || pathname.startsWith(`${item.href}/`))?.key ??
  'calendar'

const activeSection = section ?? autoSection
const logoutReturnTo = '/calendar'
const addPlantHref = '/plants/new'
const profileTimezone = Astro.locals.profileTimezone ?? null
const currentPath = `${Astro.url.pathname}${Astro.url.search}`
const loginHref = `/auth/login?returnTo=${encodeURIComponent(currentPath)}`
---

<Layout title={title}>
  <div class="min-h-screen bg-muted/20">
    <form id="app-shell-logout" method="post" action="/api/auth/sign-out" class="hidden">
      <input type="hidden" name="returnTo" value={logoutReturnTo} />
    </form>
    <div class="mx-auto flex min-h-screen max-w-7xl flex-col lg:flex-row">
      <aside class="hidden w-full max-w-xs border-b border-r border-border/60 bg-background/95 p-6 lg:flex lg:min-h-screen lg:flex-col">
        <div class="mb-8">
          <p class="text-xs font-semibold uppercase tracking-[0.2em] text-muted-foreground">
            Plant Planner
          </p>
          <h1 class="text-2xl font-bold tracking-tight text-foreground">Panel ogrodnika</h1>
          <p class="text-sm text-muted-foreground">
            Zarządzaj podlewaniem i roślinami w jednym miejscu.
          </p>
        </div>

        <nav class="flex flex-col gap-1" aria-label="Główna nawigacja">
          {navItems.map((item) => (
            <a
              href={item.href}
              aria-current={item.key === activeSection ? 'page' : undefined}
              class={[
                'rounded-xl border px-4 py-3 text-left transition-colors duration-150 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring',
                item.key === activeSection
                  ? 'border-primary bg-primary/10 text-primary'
                  : 'border-transparent text-foreground hover:border-border hover:bg-muted/60',
              ]
                .filter(Boolean)
                .join(' ')}
            >
              <span class="text-base font-semibold">{item.label}</span>
              <p class="text-xs text-muted-foreground">{item.description}</p>
            </a>
          ))}
        </nav>

        <div class="mt-auto space-y-3 pt-10">
          <a
            href={addPlantHref}
            class="inline-flex w-full items-center justify-center rounded-xl bg-primary px-4 py-3 text-sm font-semibold text-primary-foreground transition hover:bg-primary/90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring"
          >
            Dodaj roślinę
          </a>
          <button
            type="submit"
            form="app-shell-logout"
            class="inline-flex w-full items-center justify-center rounded-xl border border-muted-foreground/40 px-4 py-3 text-sm font-semibold text-muted-foreground transition hover:bg-muted focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring"
          >
            Wyloguj
          </button>
          <p class="text-xs text-muted-foreground">
            Sesja wygaśnie po okresie bezczynności. Wróć do panelu logowania, jeśli zobaczysz błąd
            autoryzacji.
          </p>
        </div>
      </aside>

      <div class="flex flex-1 flex-col">
        <header class="border-b border-border/70 bg-background/80 backdrop-blur lg:border-b-0 lg:border-l">
          <div class="flex flex-col gap-4 px-4 py-4 sm:flex-row sm:items-center sm:justify-between">
            <div>
              <p class="text-xs font-semibold uppercase tracking-[0.25em] text-muted-foreground">
                Plant Planner
              </p>
              <p class="text-base text-muted-foreground">
                {activeSection === 'calendar'
                  ? 'Widok kalendarza'
                  : activeSection === 'plants'
                    ? 'Lista roślin'
                    : 'Ustawienia profilu'}
              </p>
            </div>
            <div class="flex flex-wrap items-center gap-2">
              <a
                href={addPlantHref}
                class="inline-flex items-center justify-center rounded-full border border-primary px-4 py-2 text-sm font-semibold text-primary transition hover:bg-primary/10 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring"
              >
                Dodaj roślinę
              </a>
              <button
                type="submit"
                form="app-shell-logout"
                class="inline-flex items-center justify-center rounded-full border border-border px-4 py-2 text-sm font-semibold text-muted-foreground transition hover:bg-muted focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring"
              >
                Wyloguj
              </button>
            </div>
          </div>
          <nav class="flex justify-around border-t border-border/70 bg-background px-2 py-2 text-sm lg:hidden">
            {navItems.map((item) => (
              <a
                href={item.href}
                aria-current={item.key === activeSection ? 'page' : undefined}
                class={[
                  'flex flex-1 items-center justify-center rounded-full px-3 py-2 font-medium transition',
                  item.key === activeSection
                    ? 'bg-primary/10 text-primary'
                    : 'text-muted-foreground hover:bg-muted/60',
                ]
                  .filter(Boolean)
                  .join(' ')}
              >
                {item.label}
              </a>
            ))}
          </nav>
        </header>

        <main class="flex-1 bg-background px-4 py-6 sm:px-6 lg:px-10">
          <slot />
        </main>

        <footer class="border-t border-border/70 bg-background px-4 py-3 text-center text-xs text-muted-foreground">
          Sesja zakończona? <a href={loginHref} class="font-semibold text-primary underline-offset-4 hover:underline">Wróć do logowania</a>.
        </footer>
      </div>
    </div>
  </div>

  <script is:inline define:vars={{ profileTimezone }}>
    window.__PLANT_PLANNER_PROFILE__ = window.__PLANT_PLANNER_PROFILE__ ?? {};
    window.__PLANT_PLANNER_PROFILE__.timezone = profileTimezone;
  </script>
</Layout>
