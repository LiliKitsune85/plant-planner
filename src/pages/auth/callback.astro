---
import { AuthCard } from "@/components/auth/AuthCard";
import { Button } from "@/components/ui/button";
import AuthLayout from "@/layouts/AuthLayout.astro";

export const prerender = false;

const code = Astro.url.searchParams.get("code");
const errorCode = Astro.url.searchParams.get("error");
const errorDescription = Astro.url.searchParams.get("error_description");
const rawReturnTo = Astro.url.searchParams.get("returnTo");
const returnTo = rawReturnTo && rawReturnTo.startsWith("/") ? rawReturnTo : "/calendar";
const loginHref = `/auth/login?returnTo=${encodeURIComponent(returnTo)}`;

let message = "";

if (errorCode) {
  message = errorDescription ? decodeURIComponent(errorDescription) : "Nie udało się potwierdzić konta.";
} else if (code) {
  const { error } = await Astro.locals.supabase.auth.exchangeCodeForSession(code);
  if (error) {
    message = error.message || "Nie udało się potwierdzić konta.";
  } else {
    return Astro.redirect(returnTo);
  }
} else {
  message = "Brakuje kodu potwierdzającego. Upewnij się, że link z e-maila jest poprawny.";
}
---

<AuthLayout
  title="Plant Planner — potwierdzenie e-maila"
  heading="Nie udało się potwierdzić konta"
  description="Sprawdź komunikat poniżej i spróbuj ponownie."
  eyebrow="Problem z linkiem"
>
  <AuthCard title="Wystąpił problem" description={message}>
    <div class="flex flex-wrap gap-2">
      <Button asChild>
        <a href={loginHref}>Przejdź do logowania</a>
      </Button>
      <Button asChild variant="outline">
        <a href="/auth/register">Wróć do rejestracji</a>
      </Button>
    </div>
  </AuthCard>
</AuthLayout>
